<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 全域變數，等待 JSON 載入後填充
    let tripData = null;
    let locations = {};
    let schedule = [];
    let meta = {};
    let currentActiveIndex = -1;

    // DOM Elements
    const pageTitleEl = document.getElementById('page-title');
    const headerTitleEl = document.getElementById('header-title');
    const cardsContainer = document.getElementById('cards-container');
    const detailsContainer = document.getElementById('details-container');

    // Map init (初始化地圖，但先不放點)
    const map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        zoomAnimation: true,
        fadeAnimation: true,
        markerZoomAnimation: true
    }).setView([35.69, 139.75], 10);

    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 18
    }).addTo(map);

    const currentLayerGroup = L.layerGroup().addTo(map);

    // --- 核心邏輯：讀取資料 ---
    async function initApp() {
        // 1. 從網址取得參數 ?trip=xxx，預設為 tokyo
        const params = new URLSearchParams(window.location.search);
        const tripId = params.get('trip') || 'tokyo'; 

        try {
            // 2. 嘗試讀取 JSON
            const response = await fetch(`./data/${tripId}.json`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            tripData = await response.json();
            
            // 3. 分配資料到全域變數
            meta = tripData.meta;
            locations = tripData.locations;
            schedule = tripData.schedule;

            // 4. 更新畫面標題
            if(meta.title) {
                document.title = meta.title; // 瀏覽器分頁標題
                pageTitleEl.innerText = meta.title;
                headerTitleEl.innerText = meta.title;
            }

            // 5. 啟動渲染
            renderCards();
            setTimeout(resetView, 300);

        } catch (error) {
            console.error('Fetch error:', error);
            alert('無法讀取行程資料，請確認 data 資料夾內是否有對應的 .json 檔案。\n\n錯誤: ' + error.message);
        }
    }

    // --- 以下為 UI 邏輯 (大部分未變動，僅微調適應非同步載入) ---

    function createPinIcon(type) {
        let colorClass = 'pin-normal';
        if (type === 'start') colorClass = 'pin-start';
        if (type === 'dest') colorClass = 'pin-dest';
        if (type === 'mid') colorClass = 'pin-mid';

        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="pin-drop ${colorClass}"><i class="fas fa-map-marker-alt pin-icon"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 42]
        });
    }

    function focusOnLocation(lat, lng) {
        if (typeof lat !== 'number' || typeof lng !== 'number') return;
        map.flyTo([lat, lng], 14, {
            duration: 0.8,
            easeLinearity: 0.25
        });
    }

    function updateMapRoute(day) {
        currentLayerGroup.clearLayers();
        if (!day.route || !day.route.length) return;

        const points = [];
        day.route.forEach((locKey, i) => {
            const loc = locations[locKey];
            if (!loc) return; // 保護機制：如果 JSON 寫錯 key

            const pt = [loc.lat, loc.lng];
            points.push(pt);

            let type = 'mid';
            if (i === 0) type = 'start';
            else if (i === day.route.length - 1) type = 'dest';

            const marker = L.marker(pt, {
                icon: createPinIcon(type),
                zIndexOffset: type === 'dest' ? 1000 : 0
            }).addTo(currentLayerGroup);

            if (i === 0 || i === day.route.length - 1) {
                marker.bindTooltip(loc.title, {
                    permanent: true,
                    direction: 'bottom',
                    offset: [0, 5],
                    className: 'map-label'
                });
            }
        });

        if (points.length > 0) {
            L.polyline(points, {
                color: '#2563eb',
                weight: 6,
                opacity: 0.9,
                dashArray: '12, 6',
                lineCap: 'round'
            }).addTo(currentLayerGroup);

            map.flyToBounds(points, {
                padding: [60, 60],
                duration: 1.0,
                easeLinearity: 0.25
            });
        }
    }

    function selectDay(index) {
        if (currentActiveIndex === index) {
            resetView();
            return;
        }
        currentActiveIndex = index;

        const day = schedule[index];
        if (!day) return;

        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${index}`);
        if (card) {
            card.classList.add('active');
            card.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
        }

        renderDetails(day);
        detailsContainer.scrollTop = 0;
        updateMapRoute(day);
    }

    function resetView() {
        currentActiveIndex = -1;
        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        currentLayerGroup.clearLayers();

        const points = [];
        schedule.forEach(day => {
            if (!day.route) return;
            day.route.forEach(locKey => {
                const loc = locations[locKey];
                if (!loc) return;
                points.push([loc.lat, loc.lng]);
            });
        });

        const used = new Set();
        const mainMarkers = [];
        points.forEach(([lat, lng]) => {
            const key = `${lat.toFixed(3)},${lng.toFixed(3)}`;
            if (!used.has(key)) {
                used.add(key);
                mainMarkers.push([lat, lng]);
            }
        });

        mainMarkers.slice(0, 6).forEach(([lat, lng]) => {
            L.marker([lat, lng], {
                icon: createPinIcon('normal')
            }).addTo(currentLayerGroup);
        });

        if (mainMarkers.length > 0) {
            map.flyToBounds(mainMarkers, {
                padding: [50, 50],
                duration: 1.0,
                easeLinearity: 0.25
            });
        }

        renderOverviewDetails();
        detailsContainer.scrollTop = 0;
    }

    function renderOverviewDetails() {
        const dayTitles = schedule.slice(0, 3).map(d => `Day ${d.id}・${d.title}`);
        
        detailsContainer.innerHTML = `
            <div class="animate-fade bg-white h-full p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 shadow-sm">
                        <i class="fas fa-route text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 tracking-wide">${meta.title || '行程規劃'}</h2>
                        <p class="text-xs text-gray-400 mt-1">${meta.subtitle || ''}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 text-xs text-gray-600 mb-4">
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">天數</div>
                        <div class="font-bold text-gray-800">${meta.days || schedule.length} 天</div>
                    </div>
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">成員</div>
                        <div class="font-bold text-gray-800 truncate">${meta.people || '-'}</div>
                    </div>
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">類型</div>
                        <div class="font-bold text-gray-800">自助遊</div>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    ${dayTitles.map((t, idx) => `
                        <div class="group p-3 rounded-2xl border border-gray-100 hover:border-blue-200 hover:bg-blue-50/40 transition-all cursor-pointer"
                             onclick="selectDay(${idx})">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-500 font-mono text-xs">
                                    D${idx + 1}
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs font-bold text-gray-700 group-hover:text-blue-600">${t}</div>
                                </div>
                                <i class="fas fa-chevron-right text-[10px] text-gray-300 group-hover:text-blue-400"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="overview-hint">
                    <i class="fas fa-chevron-up mb-2"></i>
                    <div>點擊上方卡片查看每日詳情</div>
                </div>
            </div>
        `;
    }

    function renderDetails(day) {
        detailsContainer.innerHTML = `
            <div class="animate-fade details-wrapper">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <div class="text-sm text-blue-600 font-bold mb-1 tracking-wider uppercase">Day ${day.id}</div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">${day.title}</h2>
                        <p class="text-xs text-gray-400 mt-1">${day.week || ''}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-gray-200 font-mono">${day.date.split('/')[1]}</span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">Weather</div>
                        <div class="text-sm font-bold text-gray-700">
                            <i class="fas fa-temperature-high text-gray-400 mr-2"></i>${day.temp || '-'}
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">Wear</div>
                        <div class="text-sm font-bold text-gray-700 truncate">
                            <i class="fas fa-tshirt text-gray-400 mr-2"></i>${day.wear || ''}
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${day.events.map(e => {
                        const loc = e.locKey ? locations[e.locKey] : null;
                        const clickable = !!loc;
                        return `
                        <div class="timeline-row ${e.highlight ? 'highlight' : ''}"
                             ${clickable ? `onclick="focusOnLocation(${loc.lat}, ${loc.lng})"` : ''}>
                            <div class="dot-marker"></div>
                            <div class="time-col">${e.time || ''}</div>
                            <div class="content-col ${clickable ? 'cursor-pointer' : ''}">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <div class="text-[15px] font-bold text-gray-800 leading-snug">${e.title}</div>
                                        ${e.sub ? `<div class="text-xs text-gray-500 mt-1 leading-relaxed">${e.sub}</div>` : ''}
                                    </div>
                                    ${clickable ? `
                                    <div class="w-6 h-6 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-[10px] ml-2 flex-shrink-0">
                                        <i class="fas fa-location-arrow"></i>
                                    </div>` : ''}
                                </div>
                                ${e.highlight ? `
                                <div class="mt-2 inline-block px-2 py-0.5 bg-red-50 text-red-500 text-[10px] font-bold rounded">
                                    重點行程
                                </div>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function renderCards() {
        cardsContainer.innerHTML = '';
        if(!schedule) return;
        
        schedule.forEach((day, index) => {
            const card = document.createElement('div');
            card.className = 'day-card';
            card.id = `card-${index}`;
            card.innerHTML = `
                <div class="card-bg" style="background-image: url('${day.bg}')"></div>
                <div class="card-overlay"></div>
                <div class="card-content">
                    <div class="text-white">
                        <span class="font-bold text-lg leading-none">${day.date}</span>
                        <div class="text-[10px] font-medium opacity-90 mt-1">${day.week}</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-white/80 font-medium mb-0.5 truncate">${day.title}</div>
                        <div class="text-xs font-bold text-white truncate flex items-center">
                            <i class="fas fa-map-pin mr-1 text-[10px] opacity-80"></i>${(day.locName || '').split(' ')[0]}
                        </div>
                    </div>
                </div>
            `;
            card.onclick = () => selectDay(index);
            cardsContainer.appendChild(card);
        });
    }

    if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
        navigator.serviceWorker.register('./sw.js');
    }

    // 啟動點：改為呼叫 initApp
    window.onload = initApp;

</script>
