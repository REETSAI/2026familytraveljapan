<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="page-title">Loading...</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap');

        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #faf9f6;
            color: #374151;
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior-y: none;
        }

        /* Header */
        .app-header {
            min-height: 60px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: 48px 1fr 48px;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
            z-index: 50;
            padding-top: calc(10px + env(safe-area-inset-top));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: 10px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            color: #6b7280;
            font-size: 1.1rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header-btn:active {
            color: #111827;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            letter-spacing: 0.08em;
        }

        /* Map */
        #map-wrapper {
            padding: 12px;
            padding-left: max(12px, env(safe-area-inset-left));
            padding-right: max(12px, env(safe-area-inset-right));
            height: 28vh;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        #map-container {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            background: #e5e7eb;
            transform: translateZ(0);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .pin-drop {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            transition: all 0.2s;
            margin: 0;
        }

        .pin-icon {
            transform: rotate(45deg);
            color: white;
            font-size: 13px;
        }

        .pin-start {
            background-color: #10b981;
        }

        .pin-dest {
            background-color: #ef4444;
        }

        .pin-mid {
            background-color: #3b82f6;
        }

        .pin-normal {
            background-color: #8b5cf6;
        }

        .map-label {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            color: #1f2937;
            font-weight: 700;
            font-size: 11px;
            text-align: center;
            padding: 3px 8px;
            font-family: 'Noto Sans TC', sans-serif;
            margin-top: 2px;
        }

        .map-label::before {
            display: none;
        }

        /* Day cards */
        #cards-container {
            height: 130px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding-right: max(16px, env(safe-area-inset-right));
            padding-left: max(16px, env(safe-area-inset-left));
            gap: 12px;
            margin-top: 4px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #cards-container::-webkit-scrollbar {
            display: none;
        }

        .day-card {
            flex: 0 0 100px;
            height: 100px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            background: #f3f4f6;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            transform: translateZ(0);
        }

        .day-card.active {
            border-color: #3b82f6;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px -4px rgba(59, 130, 246, 0.4);
        }

        .card-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transition: transform 0.3s ease;
        }

        .day-card.active .card-bg {
            transform: scale(1.1);
        }

        .card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top,
            rgba(0, 0, 0, 0.8) 0%,
            rgba(0, 0, 0, 0.3) 50%,
            rgba(0, 0, 0, 0) 100%);
            z-index: 1;
        }

        .card-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
        }

        /* Details */
        #details-container {
            flex: 1;
            background: white;
            border-top: 1px solid #f3f4f6;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 8px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.02);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .details-wrapper {
            padding: 24px 20px 40px 20px;
            padding-bottom: calc(40px + env(safe-area-inset-bottom));
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .info-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
        }

        .timeline-container {
            position: relative;
            padding-left: 0;
        }

        .timeline-line {
            position: absolute;
            left: 60px;
            top: 8px;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
            z-index: 0;
        }

        .timeline-row {
            position: relative;
            display: flex;
            align-items: flex-start;
            margin-bottom: 24px;
            z-index: 1;
        }

        .timeline-row:last-child {
            margin-bottom: 0;
        }

        .time-col {
            flex: 0 0 48px;
            text-align: right;
            font-family: 'Roboto Mono', monospace;
            font-size: 13px;
            color: #6b7280;
            padding-top: 2px;
            font-weight: 500;
            margin-right: 28px;
        }

        .dot-marker {
            position: absolute;
            left: 56px;
            top: 7px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
            border: 2px solid #d1d5db;
            z-index: 2;
        }

        .timeline-row.highlight .dot-marker {
            background: #ef4444;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .content-col {
            flex: 1;
            background: white;
            padding-bottom: 4px;
        }

        .overview-hint {
            margin-top: 30px;
            text-align: center;
            color: #9ca3af;
            font-size: 12px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
            60% {
                transform: translateY(-3px);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-btn" onclick="resetView()">
        <i class="fas fa-home"></i>
    </div>
    <h1 class="header-title" id="header-title"></h1>
    <div class="header-btn" style="cursor: default;"></div>
</header>

<div id="map-wrapper">
    <div id="map-container">
        <div id="map"></div>
    </div>
</div>

<div id="cards-container"></div>
<div id="details-container"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 全域變數
    let tripData = null;
    let locations = {};
    let schedule = [];
    let meta = {};
    let currentActiveIndex = -1;

    // DOM Elements
    const pageTitleEl = document.getElementById('page-title');
    const headerTitleEl = document.getElementById('header-title');
    const cardsContainer = document.getElementById('cards-container');
    const detailsContainer = document.getElementById('details-container');

    // Map Init
    const map = L.map('map', {
        zoomControl: false,
        attributionControl: false,
        zoomAnimation: true,
        fadeAnimation: true,
        markerZoomAnimation: true
    }).setView([35.69, 139.75], 10);

    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 18
    }).addTo(map);

    const currentLayerGroup = L.layerGroup().addTo(map);

    // --- 核心邏輯：讀取資料 ---
    async function initApp() {
        // 1. 取得網址參數，例如 ?trip=osaka
        const params = new URLSearchParams(window.location.search);
        
        // 預設檔案名稱：'tokyo-2026-01-02'
        let tripName = params.get('trip') || 'tokyo-2026-01-02';

        // 自動補上 .json 副檔名 (如果網址沒打的話)
        if (!tripName.endsWith('.json')) {
            tripName += '.json';
        }

        try {
            // 2. Fetch 資料
            // 注意：這裡假設 json 檔跟 index.html 放在「同一層目錄」
            const response = await fetch(`./${tripName}`);
            
            if (!response.ok) {
                throw new Error(`找不到行程檔 (${tripName})，請確認檔案名稱或路徑正確。`);
            }
            
            tripData = await response.json();
            
            // 3. 分配資料
            meta = tripData.meta || {};
            locations = tripData.locations || {};
            schedule = tripData.schedule || [];

            // 4. 更新畫面標題
            if(meta.title) {
                document.title = meta.title; 
                pageTitleEl.innerText = meta.title;
                headerTitleEl.innerText = meta.title;
            }

            // 5. 啟動渲染
            renderCards();
            setTimeout(resetView, 300);

        } catch (error) {
            console.error('Fetch error:', error);
            // 顯示友善錯誤訊息給使用者
            headerTitleEl.innerText = "載入失敗";
            detailsContainer.innerHTML = `
                <div class="p-8 text-center text-gray-400">
                    <i class="fas fa-exclamation-circle text-4xl mb-4 text-red-300"></i>
                    <h3 class="font-bold text-gray-600 mb-2">無法讀取行程</h3>
                    <p class="text-xs text-gray-400 font-mono bg-gray-100 p-2 rounded break-all">${error.message}</p>
                    <p class="mt-4 text-xs">請確認 ${tripName} 檔案是否存在於 GitHub 倉庫中。</p>
                </div>
            `;
        }
    }

    // --- UI 邏輯 ---

    function createPinIcon(type) {
        let colorClass = 'pin-normal';
        if (type === 'start') colorClass = 'pin-start';
        if (type === 'dest') colorClass = 'pin-dest';
        if (type === 'mid') colorClass = 'pin-mid';

        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="pin-drop ${colorClass}"><i class="fas fa-map-marker-alt pin-icon"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 42]
        });
    }

    function focusOnLocation(lat, lng) {
        if (typeof lat !== 'number' || typeof lng !== 'number') return;
        map.flyTo([lat, lng], 14, {
            duration: 0.8,
            easeLinearity: 0.25
        });
    }

    function updateMapRoute(day) {
        currentLayerGroup.clearLayers();
        if (!day.route || !day.route.length) return;

        const points = [];
        day.route.forEach((locKey, i) => {
            const loc = locations[locKey];
            if (!loc) return;

            const pt = [loc.lat, loc.lng];
            points.push(pt);

            let type = 'mid';
            if (i === 0) type = 'start';
            else if (i === day.route.length - 1) type = 'dest';

            const marker = L.marker(pt, {
                icon: createPinIcon(type),
                zIndexOffset: type === 'dest' ? 1000 : 0
            }).addTo(currentLayerGroup);

            if (i === 0 || i === day.route.length - 1) {
                marker.bindTooltip(loc.title, {
                    permanent: true,
                    direction: 'bottom',
                    offset: [0, 5],
                    className: 'map-label'
                });
            }
        });

        if (points.length > 0) {
            L.polyline(points, {
                color: '#2563eb',
                weight: 6,
                opacity: 0.9,
                dashArray: '12, 6',
                lineCap: 'round'
            }).addTo(currentLayerGroup);

            map.flyToBounds(points, {
                padding: [60, 60],
                duration: 1.0,
                easeLinearity: 0.25
            });
        }
    }

    function selectDay(index) {
        // 點擊相同卡片 -> 回到首頁 (Reset)
        if (currentActiveIndex === index) {
            resetView();
            return;
        }
        currentActiveIndex = index;

        const day = schedule[index];
        if (!day) return;

        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${index}`);
        if (card) {
            card.classList.add('active');
            card.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
        }

        renderDetails(day);
        
        // 捲動內容置頂
        detailsContainer.scrollTop = 0;
        
        updateMapRoute(day);
    }

    function resetView() {
        currentActiveIndex = -1;
        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        currentLayerGroup.clearLayers();

        const points = [];
        schedule.forEach(day => {
            if (!day.route) return;
            day.route.forEach(locKey => {
                const loc = locations[locKey];
                if (!loc) return;
                points.push([loc.lat, loc.lng]);
            });
        });

        // 簡單去重 + 顯示總覽 Marker
        const used = new Set();
        const mainMarkers = [];
        points.forEach(([lat, lng]) => {
            const key = `${lat.toFixed(3)},${lng.toFixed(3)}`;
            if (!used.has(key)) {
                used.add(key);
                mainMarkers.push([lat, lng]);
            }
        });

        // 最多顯示前 8 個點，避免畫面太亂
        mainMarkers.slice(0, 8).forEach(([lat, lng]) => {
            L.marker([lat, lng], {
                icon: createPinIcon('normal')
            }).addTo(currentLayerGroup);
        });

        if (mainMarkers.length > 0) {
            map.flyToBounds(mainMarkers, {
                padding: [50, 50],
                duration: 1.0,
                easeLinearity: 0.25
            });
        }

        renderOverviewDetails();
        
        // 捲動內容置頂
        detailsContainer.scrollTop = 0;
    }

    function renderOverviewDetails() {
        // 這裡做一個保護，避免 schedule 是空的時候報錯
        if(!schedule || schedule.length === 0) return;

        const dayTitles = schedule.map((d, i) => ({ id: d.id || i+1, title: d.title }));
        
        detailsContainer.innerHTML = `
            <div class="animate-fade bg-white h-full p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600 shadow-sm">
                        <i class="fas fa-route text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-800 tracking-wide">${meta.title || '行程規劃'}</h2>
                        <p class="text-xs text-gray-400 mt-1">${meta.subtitle || '載入完成'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 text-xs text-gray-600 mb-4">
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">天數</div>
                        <div class="font-bold text-gray-800">${meta.days || schedule.length} 天</div>
                    </div>
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">成員</div>
                        <div class="font-bold text-gray-800 truncate">${meta.people || '-'}</div>
                    </div>
                    <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100">
                        <div class="text-[10px] uppercase tracking-wide text-gray-400 mb-1">類型</div>
                        <div class="font-bold text-gray-800">自助遊</div>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    ${dayTitles.map((t, idx) => `
                        <div class="group p-3 rounded-2xl border border-gray-100 hover:border-blue-200 hover:bg-blue-50/40 transition-all cursor-pointer"
                             onclick="selectDay(${idx})">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-500 font-mono text-xs">
                                    D${idx + 1}
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs font-bold text-gray-700 group-hover:text-blue-600">Day ${t.id}・${t.title}</div>
                                </div>
                                <i class="fas fa-chevron-right text-[10px] text-gray-300 group-hover:text-blue-400"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="overview-hint">
                    <i class="fas fa-chevron-up mb-2"></i>
                    <div>點擊上方卡片查看每日詳情</div>
                </div>
            </div>
        `;
    }

    function renderDetails(day) {
        detailsContainer.innerHTML = `
            <div class="animate-fade details-wrapper">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <div class="text-sm text-blue-600 font-bold mb-1 tracking-wider uppercase">Day ${day.id}</div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">${day.title}</h2>
                        <p class="text-xs text-gray-400 mt-1">${day.week || ''}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-gray-200 font-mono">${day.date.split('/')[1]}</span>
                    </div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">Weather</div>
                        <div class="text-sm font-bold text-gray-700">
                            <i class="fas fa-temperature-high text-gray-400 mr-2"></i>${day.temp || '-'}
                        </div>
                    </div>
                    <div class="info-box">
                        <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase tracking-wide">Wear</div>
                        <div class="text-sm font-bold text-gray-700 truncate">
                            <i class="fas fa-tshirt text-gray-400 mr-2"></i>${day.wear || ''}
                        </div>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${day.events.map(e => {
                        const loc = e.locKey ? locations[e.locKey] : null;
                        const clickable = !!loc;
                        return `
                        <div class="timeline-row ${e.highlight ? 'highlight' : ''}"
                             ${clickable ? `onclick="focusOnLocation(${loc.lat}, ${loc.lng})"` : ''}>
                            <div class="dot-marker"></div>
                            <div class="time-col">${e.time || ''}</div>
                            <div class="content-col ${clickable ? 'cursor-pointer' : ''}">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <div class="text-[15px] font-bold text-gray-800 leading-snug">${e.title}</div>
                                        ${e.sub ? `<div class="text-xs text-gray-500 mt-1 leading-relaxed">${e.sub}</div>` : ''}
                                    </div>
                                    ${clickable ? `
                                    <div class="w-6 h-6 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 text-[10px] ml-2 flex-shrink-0">
                                        <i class="fas fa-location-arrow"></i>
                                    </div>` : ''}
                                </div>
                                ${e.highlight ? `
                                <div class="mt-2 inline-block px-2 py-0.5 bg-red-50 text-red-500 text-[10px] font-bold rounded">
                                    重點行程
                                </div>` : ''}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>
        `;
    }

    function renderCards() {
        cardsContainer.innerHTML = '';
        if(!schedule) return;
        
        schedule.forEach((day, index) => {
            const card = document.createElement('div');
            card.className = 'day-card';
            card.id = `card-${index}`;
            card.innerHTML = `
                <div class="card-bg" style="background-image: url('${day.bg}')"></div>
                <div class="card-overlay"></div>
                <div class="card-content">
                    <div class="text-white">
                        <span class="font-bold text-lg leading-none">${day.date}</span>
                        <div class="text-[10px] font-medium opacity-90 mt-1">${day.week}</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-white/80 font-medium mb-0.5 truncate">${day.title}</div>
                        <div class="text-xs font-bold text-white truncate flex items-center">
                            <i class="fas fa-map-pin mr-1 text-[10px] opacity-80"></i>${(day.locName || '').split(' ')[0]}
                        </div>
                    </div>
                </div>
            `;
            card.onclick = () => selectDay(index);
            cardsContainer.appendChild(card);
        });
    }

    if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
        navigator.serviceWorker.register('./sw.js');
    }

    // 程式入口
    window.onload = initApp;

</script>
</body>
</html>
