<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="page-title">Loading...</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto+Mono:wght@500&display=swap');

        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #faf9f6;
            color: #374151;
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior-y: none;
        }

        /* Header */
        .app-header {
            min-height: 60px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: 48px 1fr 48px;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
            z-index: 50;
            padding-top: calc(10px + env(safe-area-inset-top));
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: 10px;
        }

        .header-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            color: #6b7280;
            font-size: 1.1rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 700;
            color: #111827;
            text-align: center;
            letter-spacing: 0.08em;
        }

        /* Map */
        #map-wrapper {
            padding: 12px;
            padding-left: max(12px, env(safe-area-inset-left));
            padding-right: max(12px, env(safe-area-inset-right));
            height: 35vh;
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        #map-container {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            background: #e5e7eb;
            transform: translateZ(0);
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Markers */
        .custom-div-icon { background: transparent; border: none; }
        
        .pin-drop {
            width: 28px; height: 28px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white; margin: 0;
        }
        .pin-sub {
            width: 14px; height: 14px;
            background-color: white; border: 3px solid #6b7280;
            border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .pin-icon { transform: rotate(45deg); color: white; font-size: 12px; }

        /* Colors */
        .pin-start { background-color: #10b981; } /* Green */
        .pin-dest { background-color: #ef4444; }  /* Red */
        .pin-mid { background-color: #3b82f6; }   /* Blue */
        .pin-base { background-color: #8b5cf6; }  /* Purple (Base) */
        .pin-normal { background-color: #8b5cf6; } /* Purple (Overview) */

        .leaflet-tooltip.custom-map-label {
            background-color: rgba(255, 255, 255, 0.95);
            border: none; border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 12px; font-weight: 700;
            color: #1f2937; padding: 3px 8px; white-space: nowrap;
        }
        .leaflet-tooltip-top:before { display: none; }

        /* Flowing Path */
        @keyframes flow { 0% { stroke-dashoffset: 20; } 100% { stroke-dashoffset: 0; } }
        .flowing-path { animation: flow 1s linear infinite; }

        /* Moving Arrow */
        .moving-arrow-div {
            transition: opacity 0.2s ease-out; 
            z-index: 2000 !important;
            pointer-events: none;
        }

        .minimalist-arrow {
            width: 24px; height: 24px;
            background: white; border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center;
        }
        
        .minimalist-arrow svg {
            width: 14px; height: 14px;
            fill: #1e3a8a; display: block;
        }

        /* Cards */
        #cards-container {
            height: 130px; flex-shrink: 0;
            display: flex; align-items: center;
            overflow-x: auto; gap: 12px;
            padding: 0 max(16px, env(safe-area-inset-right)) 0 max(16px, env(safe-area-inset-left));
            margin-top: 4px; scrollbar-width: none;
        }
        #cards-container::-webkit-scrollbar { display: none; }

        .day-card {
            flex: 0 0 110px; height: 100px;
            border-radius: 16px; position: relative;
            overflow: hidden; cursor: pointer;
            background: #f3f4f6; border: 2px solid transparent;
            transition: all 0.2s;
        }
        .day-card.active {
            border-color: #3b82f6; transform: translateY(-4px);
            box-shadow: 0 8px 16px -4px rgba(59, 130, 246, 0.4);
        }
        .card-bg {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            transition: transform 0.5s ease; background-color: #e5e7eb;
        }
        .day-card.active .card-bg { transform: scale(1.1); }
        .card-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 60%, rgba(0,0,0,0) 100%);
            z-index: 1;
        }
        .card-content {
            position: relative; z-index: 2; height: 100%;
            display: flex; flex-direction: column; justify-content: space-between; padding: 10px;
        }

        /* Details */
        #details-container {
            flex: 1; background: white;
            border-top: 1px solid #f3f4f6; overflow-y: auto;
            margin-top: 8px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.02);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .details-wrapper { padding: 24px 20px 40px 20px; }
        
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 12px; margin-bottom: 24px;
        }
        .info-box {
            background: #f9fafb; border: 1px solid #e5e7eb;
            border-radius: 10px; padding: 10px 14px;
            display: flex; flex-direction: column;
        }

        .timeline-container { position: relative; }
        .timeline-line {
            position: absolute; left: 60px; top: 10px; bottom: 10px;
            width: 2px; background: #e5e7eb; z-index: 0;
        }
        .timeline-row {
            position: relative; display: flex; align-items: flex-start;
            margin-bottom: 24px; z-index: 1;
        }
        .time-col {
            flex: 0 0 48px; text-align: right;
            font-family: 'Roboto Mono', monospace; font-size: 13px;
            color: #6b7280; padding-top: 3px; margin-right: 28px;
        }
        .dot-marker {
            position: absolute; left: 56px; top: 7px;
            width: 10px; height: 10px; border-radius: 50%;
            background: white; border: 2px solid #d1d5db; z-index: 2;
        }
        .content-col { flex: 1; padding-bottom: 4px; }

        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-btn" onclick="resetView()">
        <i class="fas fa-home"></i>
    </div>
    <h1 class="header-title" id="header-title"></h1>
    <div class="header-btn" style="cursor: default;"></div>
</header>

<div id="map-wrapper">
    <div id="map-container">
        <div id="map"></div>
    </div>
</div>

<div id="cards-container"></div>
<div id="details-container"></div>

<script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    const PEXELS_API_KEY = 'pXteTvWtxlGD6EmKejw4PcrQPBIq2AfT8cDjPEQX1hCufCKu2oNfaxVL'; // 填入您的 Pexels API Key

    // ==========================================
    // DEFAULT DATA
    // ==========================================
    const DEFAULT_DATA = {
      "meta": {
        "title": "東京富士親子遊",
        "subtitle": "5天4夜｜迪士尼・河口湖溫泉",
        "days": 5,
        "nights": 4,
        "people": "2大2小 (親子/放鬆)"
      },
      "schedule": [
        {
          "id": 1,
          "date": "1/2",
          "week": "週五",
          "title": "抵達上野",
          "locName": "Narita Airport",
          "stayHotel": "mimaru_ueno",
          "temp": "6°C ~ 12°C",
          "wear": "洋蔥式穿搭 | 防風外套",
          "route": ["nrt_airport", "keisei_ueno", "mimaru_ueno", "ameyoko"],
          "events": [
            { "time": "14:55", "title": "抵達成田機場 (T1)", "sub": "MM626 航班降落", "locKey": "nrt_airport", "image_query": "Airport Terminal", "maps_query": "Narita International Airport Terminal 1" },
            { "time": "16:00", "title": "Skyliner 京成電鐵", "sub": "直達上野 (約45分)", "locKey": "keisei_ueno", "image_query": "Japan Train", "maps_query": "Keisei Ueno Station" },
            { "time": "17:00", "title": "MIMARU Check-in", "sub": "親子友善公寓式酒店", "locKey": "mimaru_ueno", "image_query": "Hotel Room Family", "maps_query": "MIMARU TOKYO UENO NORTH" },
            { "time": "18:30", "title": "阿美橫丁晚餐", "sub": "體驗熱鬧氣氛", "locKey": "ameyoko", "image_query": "Tokyo Street Food", "maps_query": "Ameyoko Shopping District" }
          ]
        },
        {
          "id": 2,
          "date": "1/3",
          "week": "週六",
          "title": "淺草晴空塔",
          "locName": "Asakusa Area",
          "stayHotel": "mimaru_ueno",
          "temp": "5°C ~ 11°C",
          "wear": "舒適好走鞋 | 保暖",
          "route": ["mimaru_ueno", "sensoji", "sumida_park", "skytree", "mimaru_ueno"],
          "events": [
            { "time": "09:30", "title": "淺草寺雷門", "sub": "仲見世通吃點心", "locKey": "sensoji", "image_query": "Sensoji Temple", "maps_query": "Sensoji Temple" },
            { "time": "11:30", "title": "隅田公園散步", "sub": "步行過橋前往晴空塔", "locKey": "sumida_park", "image_query": "Park River", "maps_query": "Sumida Park" },
            { "time": "12:30", "title": "晴空塔午餐", "sub": "推薦：敘敘苑燒肉 (30F)", "locKey": "skytree", "image_query": "Yakiniku Beef", "maps_query": "Jojoen Tokyo Skytree Town Solamachi" },
            { "time": "14:30", "title": "墨田水族館", "sub": "適合親子", "locKey": "sumida_aquarium", "image_query": "Aquarium Jellyfish", "maps_query": "Sumida Aquarium" }
          ]
        },
        {
          "id": 3,
          "date": "1/4",
          "week": "週日",
          "title": "迪士尼樂園",
          "locName": "Disney Land",
          "stayHotel": "mimaru_ueno",
          "temp": "4°C ~ 10°C",
          "wear": "極暖裝備 | 暖暖包",
          "route": ["mimaru_ueno", "disneyland", "mimaru_ueno"],
          "events": [
            { "time": "09:00", "title": "東京迪士尼樂園", "sub": "卡通城、美女與野獸", "locKey": "disneyland", "image_query": "Cinderella Castle", "maps_query": "Tokyo Disneyland" },
            { "time": "13:00", "title": "園區午餐", "sub": "紅心皇后宴會大廳", "locKey": "disneyland", "image_query": "Theme Park Food", "maps_query": "Queen of Hearts Banquet Hall" },
            { "time": "17:00", "title": "夜間遊行", "sub": "視體力提早離園", "locKey": "disneyland", "image_query": "Parade Lights", "maps_query": "Tokyo Disneyland" }
          ]
        },
        {
          "id": 4,
          "date": "1/5",
          "week": "週一",
          "title": "移動至河口湖",
          "locName": "Mt Fuji",
          "stayHotel": "fuji_ginkei",
          "temp": "-2°C ~ 5°C",
          "wear": "羽絨外套 | 毛帽手套",
          "route": ["mimaru_ueno", "shinjuku_st", "kawaguchiko_st", "fuji_ropeway", "fuji_ginkei"],
          "events": [
            { "time": "10:30", "title": "富士回遊號", "sub": "直達河口湖 (需預約)", "locKey": "shinjuku_st", "image_query": "Train Scenery Mountain", "maps_query": "Shinjuku Station" },
            { "time": "12:30", "title": "午餐：不動茶屋", "sub": "河口湖名物餺飥麵", "locKey": "hoto_fudo", "image_query": "Noodle Soup Pot", "maps_query": "Hoto Fudo Kawaguchiko Station" },
            { "time": "14:30", "title": "富士全景纜車", "sub": "眺望富士山", "locKey": "fuji_ropeway", "image_query": "Cable Car Mountain", "maps_query": "Mt. Fuji Panoramic Ropeway" },
            { "time": "16:00", "title": "富士吟景 Check-in", "sub": "逆富士溫泉與懷石料理", "locKey": "fuji_ginkei", "image_query": "Ryokan Onsen", "maps_query": "Koraku Onyado Fuji Ginkei" }
          ]
        },
        {
          "id": 5,
          "date": "1/6",
          "week": "週二",
          "title": "溫泉與返程",
          "locName": "Return Home",
          "stayHotel": "fuji_ginkei",
          "temp": "0°C ~ 6°C",
          "wear": "舒適 | 適合搭機",
          "route": ["fuji_ginkei", "kawaguchiko_st", "nrt_airport"],
          "events": [
            { "time": "07:00", "title": "晨間露天風呂", "sub": "欣賞清晨的富士山", "locKey": "fuji_ginkei", "image_query": "Mt Fuji Sunrise", "maps_query": "Koraku Onyado Fuji Ginkei" },
            { "time": "11:00", "title": "前往成田機場", "sub": "預留 3.5 小時車程", "locKey": "kawaguchiko_st", "image_query": "Highway Bus", "maps_query": "Kawaguchiko Station" },
            { "time": "14:50", "title": "抵達成田機場 (T1)", "sub": "MM625 (16:50起飛)", "locKey": "nrt_airport", "image_query": "Airport Checkin", "maps_query": "Narita International Airport Terminal 1" }
          ]
        }
      ],
      "locations": {
        "nrt_airport": { "lat": 35.7719, "lng": 140.3929, "title": "成田國際機場" },
        "keisei_ueno": { "lat": 35.7113, "lng": 139.7749, "title": "京成上野站" },
        "mimaru_ueno": { "lat": 35.7135, "lng": 139.7785, "title": "MIMARU 上野" },
        "ameyoko": { "lat": 35.7107, "lng": 139.7745, "title": "阿美橫丁" },
        "sensoji": { "lat": 35.7147, "lng": 139.7967, "title": "淺草寺" },
        "sumida_park": { "lat": 35.7140, "lng": 139.8040, "title": "隅田公園" },
        "skytree": { "lat": 35.7100, "lng": 139.8107, "title": "東京晴空塔" },
        "sumida_aquarium": { "lat": 35.7102, "lng": 139.8109, "title": "墨田水族館" },
        "disneyland": { "lat": 35.6329, "lng": 139.8804, "title": "東京迪士尼樂園" },
        "shinjuku_st": { "lat": 35.6896, "lng": 139.7005, "title": "新宿站" },
        "kawaguchiko_st": { "lat": 35.4981, "lng": 138.7688, "title": "河口湖站" },
        "hoto_fudo": { "lat": 35.4996, "lng": 138.7656, "title": "不動茶屋" },
        "fuji_ropeway": { "lat": 35.5069, "lng": 138.7725, "title": "富士山全景纜車" },
        "fuji_ginkei": { "lat": 35.5097, "lng": 138.7728, "title": "富士吟景" }
      }
    };

    let tripData = null;
    let locations = {};
    let schedule = [];
    let meta = {};
    let currentActiveIndex = -1;
    let arrowAnimationId = null; // Animation ID
    let arrowMarker = null;      // Arrow Marker

    // Elements
    const pageTitleEl = document.getElementById('page-title');
    const headerTitleEl = document.getElementById('header-title');
    const cardsContainer = document.getElementById('cards-container');
    const detailsContainer = document.getElementById('details-container');

    // Map Init
    const map = L.map('map', {
        zoomControl: false, attributionControl: false, zoomAnimation: true
    }).setView([35.68, 139.76], 10);
    L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 18 }).addTo(map);
    const currentLayerGroup = L.layerGroup().addTo(map);

    // --- Pexels Logic (Enhanced for Quality) ---
    async function fetchPexelsImage(keyword) {
        if (!PEXELS_API_KEY) return `https://placehold.co/800x600/e2e8f0/64748b?text=${encodeURIComponent(keyword)}`;
        
        // 1. Append aesthetic keywords
        const enhancedQuery = `${keyword} aesthetic travel wallpaper`;
        
        try {
            // 2. Fetch 3 images, per_page=3
            const res = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(enhancedQuery)}&per_page=3&orientation=landscape&size=large`, {
                headers: { Authorization: PEXELS_API_KEY }
            });
            if (!res.ok) throw new Error('API Error');
            const data = await res.json();
            
            if (data.photos && data.photos.length > 0) {
                // 3. Randomly pick one from the top 3 results
                const randomIndex = Math.floor(Math.random() * data.photos.length);
                return data.photos[randomIndex].src.large; // Use large size for retina
            }
            return `https://placehold.co/800x600/e2e8f0/64748b?text=${encodeURIComponent(keyword)}`;
        } catch (e) {
            return `https://placehold.co/800x600/e2e8f0/64748b?text=${encodeURIComponent(keyword)}`;
        }
    }

    // --- Init ---
    async function initApp() {
        const params = new URLSearchParams(window.location.search);
        let tripName = params.get('trip');

        try {
            if (tripName) {
                if (!tripName.endsWith('.json')) tripName += '.json';
                const response = await fetch(`./${tripName}`);
                if (!response.ok) throw new Error('File not found');
                tripData = await response.json();
            } else {
                tripData = DEFAULT_DATA;
            }
        } catch (error) { tripData = DEFAULT_DATA; }
            
        meta = tripData.meta || {};
        locations = tripData.locations || {};
        schedule = tripData.schedule || [];

        if(meta.title) {
            document.title = meta.title; 
            pageTitleEl.innerText = meta.title;
            headerTitleEl.innerText = meta.title;
        }

        renderCards();
        setTimeout(resetView, 300);
    }

    // --- Helper Functions ---
    function getAngle(p1, p2) {
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        let theta = Math.atan2(dy, dx); 
        let deg = theta * 180 / Math.PI; 
        return deg + 90; 
    }

    // --- MAP ---
    function createPinIcon(type) {
        let color = 'pin-normal';
        let icon = '<i class="fas fa-map-marker-alt pin-icon"></i>';
        
        if (type === 'start') color = 'pin-start';
        else if (type === 'dest') { color = 'pin-dest'; icon = '<i class="fas fa-flag-checkered pin-icon"></i>'; }
        else if (type === 'base') { color = 'pin-base'; icon = '<i class="fas fa-home pin-icon"></i>'; }
        else if (type === 'mid') color = 'pin-mid';
        else if (type === 'normal') color = 'pin-normal'; 
        else if (type === 'sub') return L.divIcon({className: 'custom-div-icon', html: `<div class="pin-sub"></div>`, iconSize: [14, 14], iconAnchor: [7, 7]});

        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div class="pin-drop ${color}">${icon}</div>`,
            iconSize: [28, 28], iconAnchor: [14, 30], tooltipAnchor: [0, -28]
        });
    }

    function updateMapRoute(day) {
        // 1. Reset
        currentLayerGroup.clearLayers();
        if (arrowAnimationId) {
            cancelAnimationFrame(arrowAnimationId);
            arrowAnimationId = null;
        }
        if (arrowMarker) {
            arrowMarker.remove();
            arrowMarker = null;
        }

        const routeKeys = day.route || [];
        const eventKeys = (day.events || []).map(e => e.locKey).filter(k => k);
        const allKeys = Array.from(new Set([...routeKeys, ...eventKeys]));
        
        // Check for round trip
        let isRoundTrip = false;
        if (routeKeys.length >= 2) {
            const start = routeKeys[0], end = routeKeys[routeKeys.length-1];
            if (start === end) isRoundTrip = true;
            else if(locations[start] && locations[end]) {
                if(Math.abs(locations[start].lat - locations[end].lat) < 0.0001) isRoundTrip = true;
            }
        }

        const routePoints = [];
        allKeys.forEach(key => {
            const loc = locations[key];
            if (!loc) return;
            
            let type = 'sub';
            let zIndex = 400;
            
            if (routeKeys.includes(key)) {
                const fIdx = routeKeys.indexOf(key);
                const lIdx = routeKeys.lastIndexOf(key);
                
                if (isRoundTrip && (fIdx === 0 || lIdx === routeKeys.length-1) && (key === routeKeys[0] || key === routeKeys[routeKeys.length-1])) {
                    type = 'base'; zIndex = 1000;
                } else if (fIdx === 0) { type = 'start'; zIndex = 900; }
                else if (lIdx === routeKeys.length-1) { type = 'dest'; zIndex = 900; }
                else { type = 'mid'; zIndex = 600; }
            }

            const marker = L.marker([loc.lat, loc.lng], {
                icon: createPinIcon(type), zIndexOffset: zIndex
            }).addTo(currentLayerGroup);
            
            marker.bindTooltip(loc.title, {
                permanent: true, direction: 'top', className: 'custom-map-label', offset: [0, -5]
            });
        });

        routeKeys.forEach(k => {
            if(locations[k]) routePoints.push([locations[k].lat, locations[k].lng]);
        });

        if (routePoints.length > 0) {
            // Draw Line
            L.polyline(routePoints, {
                color: '#2563eb', weight: 5, opacity: 0.6,
                dashArray: '8, 8', className: 'flowing-path', lineCap: 'round'
            }).addTo(currentLayerGroup);
            
            // Fit Bounds
            const allPoints = allKeys.map(k => locations[k] ? [locations[k].lat, locations[k].lng] : null).filter(p => p);
            if(allPoints.length) map.flyToBounds(allPoints, { padding: [60, 60], duration: 1.0 });

            // --- Arrow Animation Logic ---
            if (routePoints.length > 1) {
                const latLngs = routePoints.map(p => L.latLng(p[0], p[1]));
                const distances = [];
                let totalDistance = 0;
                for (let i = 0; i < latLngs.length - 1; i++) {
                    const dist = latLngs[i].distanceTo(latLngs[i+1]);
                    distances.push(dist);
                    totalDistance += dist;
                }

                const arrowIcon = L.divIcon({
                    className: 'moving-arrow-div',
                    html: `
                    <div class="minimalist-arrow">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 2L4.5 20.29C4.21 21.01 5.14 21.65 5.76 21.12L12 15.75L18.24 21.12C18.86 21.65 19.79 21.01 19.5 20.29L12 2Z" />
                        </svg>
                    </div>`,
                    iconSize: [24, 24], iconAnchor: [12, 12]
                });

                arrowMarker = L.marker(latLngs[0], { icon: arrowIcon, zIndexOffset: 2000 }).addTo(currentLayerGroup);
                let currentTraveled = 0;
                const baseSpeedConstant = 250; 
                let isPaused = false;

                function animate() {
                    if (isPaused) { arrowAnimationId = requestAnimationFrame(animate); return; }
                    const currentZoom = map.getZoom();
                    const zoomFactor = Math.pow(2, currentZoom - 10);
                    const step = baseSpeedConstant / zoomFactor;
                    currentTraveled += step;

                    if (currentTraveled >= totalDistance) {
                        isPaused = true;
                        currentTraveled = totalDistance; 
                        arrowMarker.setOpacity(0);
                        setTimeout(() => {
                            currentTraveled = 0; 
                            if(latLngs.length > 0) arrowMarker.setLatLng(latLngs[0]);
                            arrowMarker.setOpacity(1); 
                            isPaused = false; 
                        }, 500); 
                    }

                    let distSum = 0;
                    let activeSegmentIndex = 0;
                    for (let i = 0; i < distances.length; i++) {
                        if (currentTraveled < distSum + distances[i]) { activeSegmentIndex = i; break; }
                        distSum += distances[i];
                    }
                    if (activeSegmentIndex >= latLngs.length - 1) activeSegmentIndex = latLngs.length - 2;

                    const segmentDist = distances[activeSegmentIndex];
                    const distInSegment = currentTraveled - distSum;
                    const ratio = segmentDist > 0 ? distInSegment / segmentDist : 0;

                    const startLatLng = latLngs[activeSegmentIndex];
                    const endLatLng = latLngs[activeSegmentIndex + 1];
                    const currentLat = startLatLng.lat + (endLatLng.lat - startLatLng.lat) * ratio;
                    const currentLng = startLatLng.lng + (endLatLng.lng - startLatLng.lng) * ratio;

                    arrowMarker.setLatLng([currentLat, currentLng]);

                    const p1 = map.latLngToLayerPoint(startLatLng);
                    const p2 = map.latLngToLayerPoint(endLatLng);
                    const angle = getAngle(p1, p2);

                    const iconEl = arrowMarker.getElement()?.querySelector('.minimalist-arrow');
                    if (iconEl) iconEl.style.transform = `rotate(${angle}deg)`; 
                    arrowAnimationId = requestAnimationFrame(animate);
                }
                animate();
            }
        }
    }

    function focusOnLocation(lat, lng) {
        if (!lat || !lng) return;
        map.flyTo([lat, lng], 15, { duration: 0.8 });
    }

    // --- UI Renderers ---
    function renderOverviewDetails() {
        if(!schedule.length) return;
        detailsContainer.innerHTML = `
            <div class="animate-fade bg-white h-full p-6">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600">
                        <i class="fas fa-map-location-dot text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">${meta.title}</h2>
                        <p class="text-xs text-gray-400 mt-1">${meta.subtitle}</p>
                    </div>
                </div>
                <div class="space-y-3">
                    ${schedule.map((day, idx) => `
                        <div class="group p-3 rounded-2xl border border-gray-100 hover:border-blue-200 hover:bg-blue-50/40 transition-all cursor-pointer"
                             onclick="selectDay(${idx})">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-500 font-mono text-xs">
                                    D${idx + 1}
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs font-bold text-gray-700">${day.title}</div>
                                    <div class="text-[10px] text-gray-400 mt-0.5"><i class="fas fa-map-marker-alt mr-1"></i>${day.locName}</div>
                                </div>
                                <i class="fas fa-chevron-right text-[10px] text-gray-300"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }

    function renderDetails(day) {
        detailsContainer.innerHTML = `
            <div class="animate-fade details-wrapper">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <div class="text-sm text-blue-600 font-bold mb-1 uppercase">Day ${day.id}</div>
                        <h2 class="text-2xl font-bold text-gray-800">${day.title}</h2>
                    </div>
                    <span class="text-3xl font-bold text-gray-200 font-mono">${day.date.split('/')[1] || day.date}</span>
                </div>
                <div class="timeline-container">
                    <div class="timeline-line"></div>
                    ${day.events.map(e => {
                        const loc = e.locKey ? locations[e.locKey] : null;
                        const clickable = !!loc;
                        
                        // Strict Map Query Logic
                        const mapQuery = e.maps_query; // ONLY use maps_query
                        const mapUrl = mapQuery ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapQuery)}` : '#';
                        const showMapBtn = !!mapQuery;

                        return `
                        <div class="timeline-row">
                            <div class="dot-marker"></div>
                            <div class="time-col">${e.time || ''}</div>
                            <div class="content-col">
                                <div class="flex items-start justify-between">
                                    
                                    <div class="flex-1 ${clickable ? 'cursor-pointer' : ''}" 
                                         ${clickable ? `onclick="focusOnLocation(${loc.lat}, ${loc.lng})"` : ''}>
                                        <div class="flex items-center">
                                            <span class="text-[15px] font-bold text-gray-800 leading-snug">${e.title}</span>
                                            ${clickable ? `<i class="fas fa-map-marker-alt text-gray-300 text-[10px] ml-2"></i>` : ''}
                                        </div>
                                        ${e.sub ? `<div class="text-xs text-gray-500 mt-0.5 leading-relaxed pr-2">${e.sub}</div>` : ''}
                                    </div>

                                    ${showMapBtn ? `
                                    <a href="${mapUrl}" target="_blank" 
                                       class="ml-2 flex-shrink-0 flex flex-col items-center justify-center text-blue-500 opacity-80 hover:opacity-100 active:scale-95 transition-all group"
                                       style="width: 44px;"
                                       onclick="event.stopPropagation()">
                                        <div class="w-9 h-9 rounded-full bg-blue-50 flex items-center justify-center mb-0.5 group-hover:bg-blue-100 transition-colors">
                                            <i class="fas fa-location-arrow text-sm"></i>
                                        </div>
                                        <div class="text-[9px] font-bold tracking-tight">導航</div>
                                    </a>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
    }

    function selectDay(index) {
        if (currentActiveIndex === index) { resetView(); return; }
        currentActiveIndex = index;
        const day = schedule[index];
        if (!day) return;

        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        const card = document.getElementById(`card-${index}`);
        if(card) {
            card.classList.add('active');
            card.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
        }
        renderDetails(day);
        detailsContainer.scrollTop = 0; 
        updateMapRoute(day);
    }

    function renderCards() {
        cardsContainer.innerHTML = '';
        if(!schedule) return;
        schedule.forEach((day, index) => {
            const card = document.createElement('div');
            card.className = 'day-card';
            card.id = `card-${index}`;
            card.innerHTML = `
                <div class="card-bg" id="card-bg-${index}" style="background-image: url('https://placehold.co/400x300/e2e8f0/ffffff?text=Loading')"></div>
                <div class="card-overlay"></div>
                <div class="card-content">
                    <div class="text-white">
                        <span class="font-bold text-lg leading-none">${day.date}</span>
                        <div class="text-[10px] font-medium opacity-90 mt-1">${day.week || ''}</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-white/90 font-medium mb-0.5 truncate">${day.title}</div>
                        <div class="text-xs font-bold text-white truncate flex items-center">
                            <i class="fas fa-map-pin mr-1 text-[10px] opacity-80"></i>${(day.locName || '').split(' ')[0]}
                        </div>
                    </div>
                </div>
            `;
            card.onclick = () => selectDay(index);
            cardsContainer.appendChild(card);
            
            let keyword = day.events?.[0]?.image_query || day.locName;
            fetchPexelsImage(keyword).then(url => {
                const bgEl = document.getElementById(`card-bg-${index}`);
                if(bgEl) bgEl.style.backgroundImage = `url('${url}')`;
            });
        });
    }

    function resetView() {
        currentActiveIndex = -1;
        document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
        currentLayerGroup.clearLayers();
        
        if (arrowAnimationId) {
            cancelAnimationFrame(arrowAnimationId);
            arrowAnimationId = null;
        }
        if (arrowMarker) {
            arrowMarker.remove();
            arrowMarker = null;
        }

        const unique = new Set();
        const bounds = [];
        schedule.forEach(day => {
            (day.route || []).forEach(k => {
                const loc = locations[k];
                if(loc) {
                    const key = `${loc.lat},${loc.lng}`;
                    if(!unique.has(key)) {
                        unique.add(key);
                        L.marker([loc.lat, loc.lng], {
                            icon: createPinIcon('normal'), 
                            zIndexOffset: 800
                        }).addTo(currentLayerGroup);
                        bounds.push([loc.lat, loc.lng]);
                    }
                }
            });
        });
        if(bounds.length) map.flyToBounds(bounds, {padding: [50, 50], duration: 1.0});
        renderOverviewDetails();
        detailsContainer.scrollTop = 0; 
    }

    window.onload = initApp;
</script>
</body>
</html>

